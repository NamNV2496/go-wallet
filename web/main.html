<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounts</title>
    <style>
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .card {
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 2px 2px 12px #aaa;
            padding: 16px;
            margin: 16px;
            width: 300px;
            text-decoration: none;
            color: inherit;
        }
        .card-container {
            display: flex;
            flex-wrap: wrap;
        }
    </style>
    <script>
        async function loadAccounts() {
            const token = sessionStorage.getItem('token');
            if (!token) {
                alert('No token found, please login first');
                window.location.href = 'index.html';
                return;
            }

            try {
                const response = await fetch('http://localhost:8080/api/v1/accounts', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const accounts = await response.json();
                    const container = document.getElementById('account-cards');
                    container.innerHTML = '';
                    accounts.forEach(account => {
                        const card = document.createElement('a');
                        card.href = `account.html?id=${account.id}`;
                        card.className = 'card';
                        card.innerHTML = `
                            <h2>Account ID: ${account.id}</h2>
                            <p>User ID: ${account.user_id}</p>
                            <p>Balance: ${account.balance}</p>
                            <p>Currency: ${account.currency}</p>
                            <p>Created At: ${new Date(account.created_at).toLocaleString()}</p>
                        `;
                        container.appendChild(card);
                    });
                } else {
                    throw new Error('Failed to load accounts');
                }
            } catch (error) {
                console.error('Error fetching accounts:', error);
                alert('Failed to load accounts');
            }
        }

        async function handlerCreateAccount(event) {
            event.preventDefault();
            const token = sessionStorage.getItem('token');
            if (!token) {
                alert('No token found, please login first');
                window.location.href = 'index.html';
                return;
            }

            const user_id = parseInt(document.getElementById('user_id').value, 10);
            const currency = document.getElementById('currency').value;

            try {
                const response = await fetch('http://localhost:8080/api/v1/account', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_id, currency })
                });

                if (response.ok) {
                    alert('Account created successfully');
                    closeCreateAccountPopup(); // Close the popup after successful creation
                    // Optionally reload accounts list or handle as needed
                    loadAccounts(); // Reload accounts list
                } else {
                    throw new Error('Failed to create account');
                }
            } catch (error) {
                console.error('Error creating account:', error);
                alert('Failed to create account');
            }
        }

        function openCreateAccountPopup() {
            document.getElementById('createAccountPopup').style.display = 'block';
        }

        function closeCreateAccountPopup() {
            document.getElementById('createAccountPopup').style.display = 'none';
        }

        // Load accounts on window load
        window.onload = loadAccounts;
    </script>
</head>
<body>
    <h1>Accounts</h1>
    <button onclick="openCreateAccountPopup()">Create New Account</button>
    <div id="createAccountPopup" class="popup">
        <button onclick="closeCreateAccountPopup()">Close</button>
        <form onsubmit="handlerCreateAccount(event)">
            <label for="user_id">User ID:</label>
            <input type="number" id="user_id" name="user_id" required><br><br>
            <label for="currency">Currency:</label>
            <input type="text" id="currency" name="currency" required><br><br>
            <button type="submit">Create Account</button>
        </form>
    </div>
    
    <div id="account-cards" class="card-container"></div>
</body>
</html>
